## はじめに

### リリースモデル
check
 - 9 snowflake 要チェック
 - 13 MariaDB ( 96%株がダウン )

利用方法
 - IaaS 上での MySQL

 - RDS for MySQL : ORACLE 版とは違う。サポートの対象外。競争相手。
 - HeadWeb : ORACLE CLoud　でサービスしている
 - MySQL Operator for k8s

### ライフサイクル
 - 5.7 2023/10 終了
 - 8.0 2026/04

 - 1/17 : 8.0.36 リリース、8.3 リリース

### LTS と innovation Release
 - Innovation Release 四半期ごとにリリース
 - LTS : 2 年に一回、8年間サポート

## パフォーマンスチューニング　(Inagaki)

MySQL 資料ダウンロード
https://www.mysql.com/jp/news-and-events/seminar/downloads.html

## DB チューニング (サーバー) (全体最適)

変数
```
> show variables like 'auto%'
```

```
shell> mysqladmin -uroot -S /tmp/mysql.sock variables | grep auto
```

ステータス (今の値)
```
> show status like 'innodb_buf%'
```

MySQL Workbench で一覧可能


SQL の場合
```
SELECT * FROM perfomance_schema.global_variables;
SELECT * FROM perfomance_schema.global_status;
```

### sysスキーマを使え！
パフォーマンススキーマは、MySQL 開発者用
sys スキーマは、パフォーマンススキーマを一般開発者用にビューにしたもの

```
select from sys.innodb_buffer_stats_by table order by data
```

## 流れ
ステータス変数などの情報から稼働情報を確認し,
設定値を確認、チューニングする

### サーバのコネクション＆スレッド
max_connections ( default: 151 )
thread_cache_size ( default: 9 ) ソケットのキャッシュ

```
　Too Many Connections
```
```
> show status
Max_used_connections
# 今までの最大値
Threads_created
# キャッシュミス。低い値であるべき
```

```
sort_buffer_size ( default: 256 KB )
```
1 コネクションで 1 M くらい


### Innodb
Innodb_buffer_pool_size ( default: 128 MB )
- メインメモリの 80 % 程度を割り当てる
- データとインデックスの両方をキャッシュ

Innodb_log_file_size
- pool_size の 25% から100%
- ディスクへの書き込みキャッシュ

trx_commit ( 1 )
flush_method = O_DIRECT

innodb_capacity 200


status を取得するのも、結構コストがかかるので、気を付ける。


use_fdatasync → ON
doublewrite_page → 128
io_capacity → 625

ft_result_cache_size 全文検索クエリの結果キャッシュ
max_binlog_cache_size トランザクションのキャッシュサイズ

### データ圧縮
ROW_FORMAT=COMPRESSED
透過的とそうでないものが選べる

### Replication 遅延に対応する
binlog_format は非推奨
ROW のみになる

### マルチスレッド亜プライヤー
レプリケーションのトランザクションをパラレルに実行できるようにする。

slave_pararel_type
LOGICAL_CLOCK 同じデータベースでも更新の並列化

## バックアップ時間を高速化する
EE限定 : MySQL Enterprise Backup

コミュニティ版
MySQL Shell
util.dompInstance()
util.dumpSchemas()
util.dumpTables()
util.loadDump()



## SQL チューニング (個別最適)

流れ
1. 問題となるSQLの特定
2. 実行計画やSQL実行時の稼働統計等の確認
3. SQL チューニング実施

### スロークエリ ログ
long_query_time
log_queries_not_using_indexes ( インデクスを使っていないクエリを全て )

### 今実行中のクエリを特定する
SHOW FULL PROCESSLIST

EE:　Enterprise Monitor

OCI: パフォーマンスハブ


### 実行計画
MySQL Workbench
ビジュアル的に確認できる

### SQL チューニング実施

プレフィックスインデックス ( 先頭何文字かのインデックス )

schema_unused_indexes ( 起動して今まで使われたことのないインデックス )
→ ALTER INDEX INVISIBLE ( 論理削除みたいな )


STARIGHT_JOIN 駆動表を指定しておく。



2/19 セキュリティ＆バックアップ
